<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOCXæ‹†åˆ†å®Œæ•´è¿›åº¦æµ‹è¯•</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold mb-6">DOCXæ‹†åˆ†å®Œæ•´è¿›åº¦æµ‹è¯•</h1>

    <!-- æµ‹è¯•æ§åˆ¶ -->
    <div class="mb-6 flex items-center gap-4">
      <button id="startTest" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
        å¼€å§‹æµ‹è¯•æ‹†åˆ†
      </button>
      <input id="pagesPerFile" type="number" value="5" min="1" max="100"
        class="px-3 py-2 border border-gray-300 rounded-lg w-20">
      <label>é¡µ/æ–‡ä»¶</label>
      <span class="text-sm text-gray-500">ä½¿ç”¨æµ‹è¯•æ–‡ä»¶ID: mieg4p2dbwanla4rdeh</span>
    </div>

    <!-- è¿›åº¦æ˜¾ç¤º -->
    <div id="progress" class="hidden">
      <h2 class="text-lg font-semibold mb-4">æ‹†åˆ†è¿›åº¦</h2>

      <!-- æ€»ä½“è¿›åº¦ -->
      <div class="mb-6">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
          <span><strong>æ€»ä½“è¿›åº¦</strong></span>
          <span id="totalProgress">0/0 æ–‡ä»¶</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div id="totalBar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1" id="totalPercentage">0%</div>
      </div>

      <!-- å½“å‰æ–‡ä»¶/ä»»åŠ¡è¿›åº¦ -->
      <div id="fileProgress" class="mb-6 hidden">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
          <span id="fileInfo"><strong>å½“å‰ä»»åŠ¡ï¼šç¬¬0ä¸ª</strong></span>
          <span id="fileStep">æ­¥éª¤</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="fileBar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1" id="filePercentage">0%</div>
      </div>

      <!-- å®æ—¶ç»Ÿè®¡ -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-blue-600" id="completedCount">0</div>
          <div class="text-sm text-gray-600">å·²å®Œæˆ</div>
        </div>
        <div class="bg-green-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-green-600" id="totalCount">0</div>
          <div class="text-sm text-gray-600">æ€»æ•°</div>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-purple-600" id="currentPhase">å‡†å¤‡ä¸­</div>
          <div class="text-sm text-gray-600">å½“å‰é˜¶æ®µ</div>
        </div>
      </div>

      <!-- è¯¦ç»†æ—¥å¿— -->
      <div class="bg-gray-50 rounded-lg p-4">
        <h3 class="text-sm font-semibold mb-2">å¤„ç†æ—¥å¿—</h3>
        <div class="max-h-60 overflow-y-auto bg-white rounded border p-3">
          <div id="logs" class="space-y-1 font-mono text-xs"></div>
        </div>
      </div>
    </div>

    <!-- ç»“æœæ˜¾ç¤º -->
    <div id="result" class="mt-6 p-4 bg-green-50 rounded-lg hidden">
      <h3 class="text-lg font-semibold text-green-800 mb-2">âœ… æ‹†åˆ†å®Œæˆ</h3>
      <div id="resultInfo" class="space-y-2"></div>
    </div>

    <!-- é”™è¯¯æ˜¾ç¤º -->
    <div id="error" class="mt-6 p-4 bg-red-50 rounded-lg hidden">
      <h3 class="text-lg font-semibold text-red-800 mb-2">âŒ æ‹†åˆ†å¤±è´¥</h3>
      <div id="errorInfo" class="text-red-700"></div>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById('startTest')
    const progressDiv = document.getElementById('progress')
    const resultDiv = document.getElementById('result')
    const errorDiv = document.getElementById('error')
    const logs = document.getElementById('logs')

    let totalFiles = 0
    let completedFiles = 0
    let startTime = Date.now()

    function addLog(message, type = 'info') {
      const logDiv = document.createElement('div')
      logDiv.className = `${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}`
      const timestamp = new Date().toLocaleTimeString()
      logDiv.textContent = `[${timestamp}] ${message}`
      logs.appendChild(logDiv)
      logs.scrollTop = logs.scrollHeight
    }

    function updateTotalProgress(completed, total) {
      completedFiles = completed
      totalFiles = total
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0

      document.getElementById('totalProgress').textContent = `${completed}/${total} æ–‡ä»¶`
      document.getElementById('totalBar').style.width = `${percentage}%`
      document.getElementById('totalPercentage').textContent = `${percentage}%`
      document.getElementById('completedCount').textContent = completed
      document.getElementById('totalCount').textContent = total
    }

    function updateFileProgress(fileIndex, step, percentage) {
      const fileProgressDiv = document.getElementById('fileProgress')
      fileProgressDiv.classList.remove('hidden')

      document.getElementById('fileInfo').innerHTML = `<strong>å½“å‰ä»»åŠ¡ï¼šç¬¬${fileIndex}ä¸ª</strong>`
      document.getElementById('fileStep').textContent = step
      document.getElementById('fileBar').style.width = `${percentage}%`
      document.getElementById('filePercentage').textContent = `${percentage}%`
    }

    function updatePhase(phase) {
      document.getElementById('currentPhase').textContent = phase
    }

    startBtn.addEventListener('click', () => {
      // é‡ç½®ç•Œé¢
      progressDiv.classList.remove('hidden')
      resultDiv.classList.add('hidden')
      errorDiv.classList.add('hidden')
      logs.innerHTML = ''
      startBtn.disabled = true
      startBtn.textContent = 'æ‹†åˆ†ä¸­...'
      startTime = Date.now()

      updatePhase('è¿æ¥ä¸­')
      addLog('å¼€å§‹å»ºç«‹è¿æ¥...', 'info')

      const pagesPerFile = document.getElementById('pagesPerFile').value
      const testFileId = 'mieg4p2dbwanla4rdeh'

      const eventSource = new EventSource(`/api/files/split-docx-stream?fileId=${testFileId}&pagesPerFile=${pagesPerFile}`)

      eventSource.onopen = () => {
        addLog('è¿æ¥å»ºç«‹æˆåŠŸ', 'success')
        updatePhase('å·²è¿æ¥')
      }

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data)
          console.log('æ”¶åˆ°æ¶ˆæ¯:', data)

          switch (data.type) {
            case 'info':
              addLog('â„¹ï¸ ' + data.data.message, 'info')
              break

            case 'log':
              addLog('ğŸ“ ' + data.data.message, 'info')
              break

            case 'progress':
              const progressData = data.data

              switch (progressData.type) {
                case 'total_files':
                  totalFiles = progressData.total
                  updateTotalProgress(0, totalFiles)
                  addLog(`ğŸ“Š æ€»æ–‡ä»¶æ•°: ${totalFiles}`, 'info')
                  updatePhase('æ‹†åˆ†ä¸­')
                  break

                case 'file_start':
                  updateFileProgress(progressData.current, 'å¼€å§‹å¤„ç†', 0)
                  addLog(`ğŸš€ å¼€å§‹å¤„ç†ç¬¬${progressData.current}ä¸ªæ–‡ä»¶`, 'info')
                  break

                case 'file_step':
                  updateFileProgress(progressData.fileIndex, progressData.step, progressData.percentage)
                  break

                case 'file_complete':
                  updateTotalProgress(progressData.completed, progressData.total)
                  addLog(`âœ… ç¬¬${progressData.completed}ä¸ªæ–‡ä»¶å®Œæˆ`, 'success')
                  break

                case 'all_complete':
                  updateTotalProgress(progressData.completed, progressData.total)
                  updatePhase('æ‰“åŒ…ä¸­')
                  addLog('ğŸ‰ æ‰€æœ‰æ–‡ä»¶æ‹†åˆ†å®Œæˆï¼Œå¼€å§‹æ‰“åŒ…', 'success')
                  break

                case 'zip_start':
                  updateFileProgress(0, 'åˆ›å»ºZIPæ–‡ä»¶', 0)
                  updatePhase('ZIPåˆ›å»º')
                  addLog(`ğŸ“¦ å¼€å§‹åˆ›å»ºZIPæ–‡ä»¶ï¼Œå…±${progressData.total}ä¸ªæ–‡ä»¶`, 'info')
                  break

                case 'zip_progress':
                  updateFileProgress(0, `æ‰“åŒ…: ${progressData.fileName}`, progressData.percentage)
                  if (progressData.current % 3 === 0 || progressData.current === progressData.total) {
                    addLog(`ğŸ“¦ æ‰“åŒ…è¿›åº¦: ${progressData.current}/${progressData.total}`, 'info')
                  }
                  break
              }
              break

            case 'complete':
              eventSource.close()
              const elapsed = ((Date.now() - startTime) / 1000).toFixed(1)
              addLog(`ğŸ† æ‰€æœ‰æ“ä½œå®Œæˆ! è€—æ—¶ ${elapsed} ç§’`, 'success')
              updatePhase('å·²å®Œæˆ')

              // æ˜¾ç¤ºç»“æœ
              resultDiv.classList.remove('hidden')
              document.getElementById('resultInfo').innerHTML = `
                                <div class="grid grid-cols-2 gap-4">
                                    <div><strong>æ€»æ–‡ä»¶æ•°:</strong> ${data.data.totalFiles}</div>
                                    <div><strong>æ¯æ–‡ä»¶é¡µæ•°:</strong> ${data.data.pagesPerFile}</div>
                                    <div><strong>å¤„ç†æ—¶é—´:</strong> ${elapsed} ç§’</div>
                                    <div><strong>å¹³å‡é€Ÿåº¦:</strong> ${(data.data.totalFiles / elapsed).toFixed(1)} æ–‡ä»¶/ç§’</div>
                                </div>
                                <div class="mt-3">
                                    <a href="${data.data.downloadUrl}" 
                                       class="inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                        ğŸ“¥ ä¸‹è½½ZIPæ–‡ä»¶ (${data.data.totalFiles} ä¸ªæ–‡ä»¶)
                                    </a>
                                </div>
                            `

              startBtn.disabled = false
              startBtn.textContent = 'å¼€å§‹æµ‹è¯•æ‹†åˆ†'
              break

            case 'error':
              eventSource.close()
              const errorMsg = data.data.message || 'æœªçŸ¥é”™è¯¯'
              addLog('âŒ é”™è¯¯: ' + errorMsg, 'error')
              updatePhase('å¤±è´¥')

              errorDiv.classList.remove('hidden')
              document.getElementById('errorInfo').textContent = errorMsg

              startBtn.disabled = false
              startBtn.textContent = 'å¼€å§‹æµ‹è¯•æ‹†åˆ†'
              break
          }
        } catch (e) {
          console.error('è§£ææ•°æ®å¤±è´¥:', e)
          addLog('è§£ææ•°æ®å¤±è´¥: ' + e.message, 'error')
        }
      }

      eventSource.onerror = (error) => {
        console.error('EventSourceé”™è¯¯:', error)
        addLog('è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error')
        updatePhase('è¿æ¥å¤±è´¥')

        eventSource.close()
        startBtn.disabled = false
        startBtn.textContent = 'å¼€å§‹æµ‹è¯•æ‹†åˆ†'

        errorDiv.classList.remove('hidden')
        document.getElementById('errorInfo').textContent = 'ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•'
      }
    })
  </script>
</body>

</html>